BEGIN;

-- ==========================
-- 1) Base / lookup tables
-- ==========================

CREATE TABLE country (
    country_id SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    country     VARCHAR(50) NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE city (
    city_id     SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    city        VARCHAR(50) NOT NULL,
    country_id  SMALLINT NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_city_country
        FOREIGN KEY (country_id) REFERENCES country(country_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_city_country_id ON city(country_id);

CREATE TABLE address (
    address_id  SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    address     VARCHAR(50) NOT NULL,
    address2    VARCHAR(50),
    district    VARCHAR(20) NOT NULL,
    city_id     SMALLINT NOT NULL,
    postal_code VARCHAR(10),
    phone       VARCHAR(20) NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_address_city
        FOREIGN KEY (city_id) REFERENCES city(city_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_address_city_id ON address(city_id);
CREATE INDEX idx_address_phone   ON address(phone);

-- Per spec: keep CHAR(20)
CREATE TABLE language (
    language_id SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        CHAR(20) NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE category (
    category_id SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        VARCHAR(25) NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE actor (
    actor_id    SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name  VARCHAR(45) NOT NULL,
    last_name   VARCHAR(45) NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_actor_last_name ON actor(last_name);

-- ==========================
-- 2) Film and film_text
-- ==========================

CREATE TABLE film (
    film_id              SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title                VARCHAR(128) NOT NULL,
    description          TEXT,
    release_year         SMALLINT,
    language_id          SMALLINT NOT NULL,
    original_language_id SMALLINT,
    rental_duration      SMALLINT NOT NULL DEFAULT 3,
    rental_rate          NUMERIC(4,2) NOT NULL DEFAULT 4.99,
    length               SMALLINT,
    replacement_cost     NUMERIC(5,2) NOT NULL DEFAULT 19.99,
    rating               VARCHAR(10) DEFAULT 'G',
    special_features     TEXT,
    last_update          TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_film_language
        FOREIGN KEY (language_id) REFERENCES language(language_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_film_language_orig
        FOREIGN KEY (original_language_id) REFERENCES language(language_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT chk_film_rating
        CHECK (rating IN ('G','PG','PG-13','R','NC-17'))
);

CREATE INDEX idx_film_title                  ON film(title);
CREATE INDEX idx_film_language_id            ON film(language_id);
CREATE INDEX idx_film_original_language_id   ON film(original_language_id);
CREATE INDEX idx_film_release_year           ON film(release_year);
CREATE INDEX idx_film_rental_rate            ON film(rental_rate);
CREATE INDEX idx_film_rental_duration        ON film(rental_duration);
CREATE INDEX idx_film_length                 ON film(length);
CREATE INDEX idx_film_rating                 ON film(rating);

CREATE TABLE film_text (
    film_id     SMALLINT PRIMARY KEY,
    title       VARCHAR(255) NOT NULL,
    description TEXT,
    CONSTRAINT fk_film_text_film
        FOREIGN KEY (film_id) REFERENCES film(film_id)
        ON UPDATE CASCADE ON DELETE CASCADE
);

-- Optional FTS index (works without extra extensions)
CREATE INDEX idx_filmtext_title_desc ON film_text
USING GIN (to_tsvector('english', title || ' ' || COALESCE(description, '')));

-- ===================================
-- 3) Store & Staff (circular FK fix)
-- ===================================

-- 3a) STORE (manager_staff_id is NULL initially; FK added later)
CREATE TABLE store (
    store_id          SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    manager_staff_id  SMALLINT,  -- nullable to break circular dependency
    address_id        SMALLINT NOT NULL,
    last_update       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_store_address
        FOREIGN KEY (address_id) REFERENCES address(address_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT uq_store_manager_staff_id UNIQUE (manager_staff_id)
);

CREATE INDEX idx_store_address_id       ON store(address_id);
CREATE INDEX idx_store_manager_staff_id ON store(manager_staff_id);

-- 3b) STAFF (references store)
CREATE TABLE staff (
    staff_id    SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name  VARCHAR(45) NOT NULL,
    last_name   VARCHAR(45) NOT NULL,
    address_id  SMALLINT NOT NULL,
    picture     TEXT,          -- URL or base64
    email       VARCHAR(50),
    store_id    SMALLINT NOT NULL,  -- staff belongs to a store
    active      BOOLEAN NOT NULL DEFAULT TRUE,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_staff_address
        FOREIGN KEY (address_id) REFERENCES address(address_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_staff_store
        FOREIGN KEY (store_id) REFERENCES store(store_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_staff_address_id ON staff(address_id);
CREATE INDEX idx_staff_store_id   ON staff(store_id);
CREATE INDEX idx_staff_email      ON staff(email);
CREATE INDEX idx_staff_first_name ON staff(first_name);
CREATE INDEX idx_staff_last_name  ON staff(last_name);

-- 3c) Add FK from store.manager_staff_id -> staff.staff_id
ALTER TABLE store
ADD CONSTRAINT fk_store_manager_staff
FOREIGN KEY (manager_staff_id) REFERENCES staff(staff_id)
ON UPDATE CASCADE ON DELETE RESTRICT;

-- ==========================
-- 4) Customers
-- ==========================

CREATE TABLE customer (
    customer_id SMALLINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    store_id    SMALLINT NOT NULL,
    first_name  VARCHAR(45) NOT NULL,
    last_name   VARCHAR(45) NOT NULL,
    email       VARCHAR(50),
    address_id  SMALLINT NOT NULL,
    active      BOOLEAN NOT NULL DEFAULT TRUE,
    create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_customer_address
        FOREIGN KEY (address_id) REFERENCES address(address_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_customer_store
        FOREIGN KEY (store_id) REFERENCES store(store_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_customer_store_id   ON customer(store_id);
CREATE INDEX idx_customer_address_id ON customer(address_id);
CREATE INDEX idx_customer_last_name  ON customer(last_name);
CREATE INDEX idx_customer_first_name ON customer(first_name);
CREATE INDEX idx_customer_email      ON customer(email);

-- =======================================
-- 5) Many-to-many: film_actor & category
-- =======================================

CREATE TABLE film_actor (
    actor_id    SMALLINT NOT NULL,
    film_id     SMALLINT NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_film_actor PRIMARY KEY (actor_id, film_id),
    CONSTRAINT fk_film_actor_actor
        FOREIGN KEY (actor_id) REFERENCES actor(actor_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_film_actor_film
        FOREIGN KEY (film_id) REFERENCES film(film_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_film_actor_film_id ON film_actor(film_id);

CREATE TABLE film_category (
    film_id     SMALLINT NOT NULL,
    category_id SMALLINT NOT NULL,
    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_film_category PRIMARY KEY (film_id, category_id),
    CONSTRAINT fk_film_category_film
        FOREIGN KEY (film_id) REFERENCES film(film_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_film_category_category
        FOREIGN KEY (category_id) REFERENCES category(category_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

-- ==========================
-- 6) Inventory, Rental, Payment
-- ==========================

CREATE TABLE inventory (
    inventory_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    film_id      SMALLINT NOT NULL,
    store_id     SMALLINT NOT NULL,
    last_update  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_inventory_store
        FOREIGN KEY (store_id) REFERENCES store(store_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_inventory_film
        FOREIGN KEY (film_id) REFERENCES film(film_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_inventory_film_id         ON inventory(film_id);
CREATE INDEX idx_inventory_store_film_id   ON inventory(store_id, film_id);

CREATE TABLE rental (
    rental_id    INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    rental_date  TIMESTAMP NOT NULL,
    inventory_id INTEGER NOT NULL,
    customer_id  SMALLINT NOT NULL,
    return_date  TIMESTAMP,
    staff_id     SMALLINT NOT NULL,
    last_update  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_rental UNIQUE (rental_date, inventory_id, customer_id),
    CONSTRAINT fk_rental_staff
        FOREIGN KEY (staff_id) REFERENCES staff(staff_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_rental_inventory
        FOREIGN KEY (inventory_id) REFERENCES inventory(inventory_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_rental_customer
        FOREIGN KEY (customer_id) REFERENCES customer(customer_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_rental_customer_id  ON rental(customer_id);
CREATE INDEX idx_rental_inventory_id ON rental(inventory_id);

CREATE TABLE payment (
    payment_id   INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    customer_id  SMALLINT NOT NULL,
    staff_id     SMALLINT NOT NULL,
    rental_id    INTEGER,
    amount       NUMERIC(5,2) NOT NULL,
    payment_date TIMESTAMP NOT NULL,
    last_update  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_payment_rental
        FOREIGN KEY (rental_id) REFERENCES rental(rental_id)
        ON UPDATE CASCADE ON DELETE SET NULL,
    CONSTRAINT fk_payment_staff
        FOREIGN KEY (staff_id) REFERENCES staff(staff_id)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT fk_payment_customer
        FOREIGN KEY (customer_id) REFERENCES customer(customer_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_payment_customer_id ON payment(customer_id);
CREATE INDEX idx_payment_staff_id    ON payment(staff_id);
CREATE INDEX idx_payment_rental_id   ON payment(rental_id);
CREATE INDEX idx_payment_date        ON payment(payment_date);

COMMIT;